<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>NECROMUNDA | STEEL TRACKER</title>
  <style>
    /* === RESET === */
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    /* === NEO-BRUTALISM POST-APOCALYPTIC === */
    :root {
      --black: #0a0a0a;
      --white: #fafaf5;
      --red: #ff3838;
      --orange: #ff8c38;
      --yellow: #ffd438;
      --green: #38ff88;
      --cyan: #38d4ff;
      --purple: #b838ff;
      --gray: #666666;
      --rust: #d94f2e;
      --toxic: #c7ff00;
      --steel: #8b9aa8;
    }
    
    body {
      font-family: 'Courier New', monospace;
      background: var(--white);
      color: var(--black);
      line-height: 1.5;
      padding-bottom: 60px;
    }
    
    /* === HEADER === */
    header {
      background: var(--red);
      border-bottom: 4px solid var(--black);
      padding: 12px;
      position: sticky;
      top: 0;
      z-index: 100;
      box-shadow: 0 4px 0 var(--black);
    }
    
    h1 {
      font-size: 24px;
      font-weight: 900;
      text-transform: uppercase;
      letter-spacing: 2px;
      margin-bottom: 8px;
    }
    
    .header-actions {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }
    
    /* === BUTTONS === */
    button, .btn {
      background: var(--yellow);
      color: var(--black);
      border: 4px solid var(--black);
      padding: 10px 16px;
      font-family: inherit;
      font-size: 14px;
      font-weight: 700;
      text-transform: uppercase;
      cursor: pointer;
      box-shadow: 4px 4px 0 var(--black);
      transition: transform 0.1s, box-shadow 0.1s;
      white-space: nowrap;
    }
    
    button:hover, .btn:hover {
      transform: translate(2px, 2px);
      box-shadow: 2px 2px 0 var(--black);
    }
    
    button:active, .btn:active {
      transform: translate(4px, 4px);
      box-shadow: none;
    }
    
    button.danger { background: var(--white); color: var(--red); }
    button.success { background: var(--green); }
    button.secondary { background: var(--steel); color: var(--white); }
    button.toxic { background: var(--toxic); }
    
    /* === TABS === */
    .tabs {
      display: flex;
      background: var(--orange);
      border-bottom: 4px solid var(--black);
      overflow-x: auto;
    }
    
    .tab {
      flex: 1;
      min-width: 100px;
      padding: 12px 8px;
      background: var(--gray);
      color: var(--white);
      border: none;
      border-right: 4px solid var(--black);
      font-weight: 900;
      box-shadow: none;
    }
    
    .tab:last-child { border-right: none; }
    .tab.active { background: var(--orange); color: var(--black); }
    
    /* === CONTENT === */
    .content {
      padding: 16px;
      max-width: 1200px;
      margin: 0 auto;
    }
    
    .page { display: none; }
    .page.active { display: block; }
    
    .section {
      background: var(--cyan);
      border: 4px solid var(--black);
      padding: 16px;
      margin-bottom: 20px;
      box-shadow: 6px 6px 0 var(--black);
      transform: rotate(-0.5deg);
    }
    
    .section:nth-child(even) { transform: rotate(0.5deg); background: var(--yellow); }
    .section:nth-child(3n) { background: var(--green); }

    .section ol {
      padding-left: 15px;
    }
    
    h2 {
      font-size: 20px;
      font-weight: 900;
      text-transform: uppercase;
      margin-bottom: 12px;
      text-decoration: underline;
      text-decoration-thickness: 3px;
    }
    
    /* === FORM ELEMENTS === */
    select, input[type="number"],input[type="text"], textarea {
      width: 100%;
      padding: 10px;
      border: 4px solid var(--black);
      background: var(--white);
      font-family: inherit;
      font-size: 14px;
      margin-bottom: 8px;
      box-shadow: 3px 3px 0 var(--black);
    }
    
    label {
      display: block;
      font-weight: 700;
      margin-bottom: 4px;
      text-transform: uppercase;
    }
    
    .checkbox-label {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 12px;
      background: rgba(0,0,0,0.05);
      border: 3px solid var(--black);
      margin: 8px 0;
      cursor: pointer;
      transition: all 0.1s;
    }
    
    .checkbox-label:hover {
      background: rgba(0,0,0,0.1);
      transform: translate(1px, 1px);
    }
    
    .checkbox-label input[type="checkbox"] {
      width: 20px;
      height: 20px;
      cursor: pointer;
      flex-shrink: 0;
    }
    
    /* === TABLE === */
    table {
      width: 100%;
      border-collapse: separate;
      border-spacing: 0;
      border: 4px solid var(--black);
      background: var(--white);
      margin: 12px 0;
      box-shadow: 6px 6px 0 var(--black);
      overflow-x: auto;
      display: block;
    }
    
    table thead, table tbody, table tr {
      display: table;
      width: 100%;
      table-layout: fixed;
    }
    
    th {
      background: var(--black);
      color: var(--yellow);
      padding: 10px;
      text-align: left;
      border-bottom: 4px solid var(--black);
      font-weight: 900;
      text-transform: uppercase;
      font-size: 12px;
    }
    
    td {
      padding: 10px;
      border-bottom: 3px solid var(--black);
      font-size: 13px;
      word-wrap: break-word;
    }
    
    tr:last-child td { border-bottom: none; }
    tbody tr:hover { background: var(--yellow); }
    
    /* === CHIP === */
    .chip {
      background: var(--purple);
      color: var(--white);
      padding: 6px 12px;
      border: 3px solid var(--black);
      font-weight: 700;
      font-size: 12px;
      box-shadow: 3px 3px 0 var(--black);
      text-transform: uppercase;
      display: inline-block;
      margin: 4px;
    }
    
    /* === FIGHTER CARD === */
    .fighter-card {
      background: var(--white);
      border: 4px solid var(--black);
      padding: 16px;
      margin-bottom: 16px;
      box-shadow: 10px 10px 0 var(--black);
      transform: rotate(-1deg);
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .fighter-card:nth-child(even) { transform: rotate(1deg); }
    .fighter-card.ooa { background: var(--rust); color: var(--white); }
    .fighter-card.collapsed { padding: 12px 16px; }
    .fighter-card:hover { transform: rotate(0deg) scale(1.01); }
    
    /* === LOG === */
    .log {
      background: var(--white);
      border: 4px solid var(--black);
      padding: 12px;
      margin: 12px 0;
      max-height: 200px;
      overflow-y: auto;
      font-size: 12px;
      box-shadow: 3px 3px 0 var(--black);
    }
    
    .log-entry {
      padding: 4px 0;
      border-bottom: 2px dashed var(--gray);
    }
    
    /* === MODAL === */
    .modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.9);
      z-index: 1000;
      padding: 20px;
      overflow-y: auto;
      display: none;
      align-items: center;
      justify-content: center;
    }
    
    .modal.active { display: flex; }
    
    .modal-content {
      background: var(--cyan);
      border: 4px solid var(--black);
      padding: 24px;
      max-width: 600px;
      width: 100%;
      box-shadow: 10px 10px 0 var(--black);
      max-height: 90vh;
      overflow-y: auto;
    }
    
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
      border-bottom: 3px solid var(--black);
      padding-bottom: 12px;
    }
    
    .modal-header h2 {
      font-size: 20px;
      font-weight: 900;
      text-transform: uppercase;
      margin: 0;
    }

    #modal-body b {
      color: var(--red);
      font-weight: bolder;
      font-size: 16px;
    }
    
    /* === TACTICS PANEL === */
    .tactics-panel {
      background: var(--purple);
      border: 4px solid var(--black);
      padding: 12px;
      margin-bottom: 20px;
      box-shadow: 6px 6px 0 var(--black);
    }
    
    .tactics-panel h3 {
      color: var(--yellow);
      margin-bottom: 8px;
      font-weight: 900;
      text-transform: uppercase;
    }

    .tactics-panel .chip {
      color: var(--purple);
      background: var(--yellow);
      font-weight: 800;
    }
    
    /* === GRID === */
    .button-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 8px;
      margin: 12px 0;
    }
    
    .button-grid button {
      font-size: 11px;
      padding: 8px;
    }

    
    /* === MOBILE === */
    @media (max-width: 640px) {
      button, .btn {
        font-size: 12px;
        padding: 8px 12px;
      }
      
      th, td {
        padding: 6px;
        font-size: 11px;
      }
      
      .fighter-card {
        transform: rotate(0deg) !important;
      }
      
      .section {
        transform: rotate(0deg) !important;
      }
      
      h1 {
        font-size: 20px;
      }
      
      h2 {
        font-size: 18px;
      }
    }
  </style>
</head>
<body>
  <!-- HEADER -->
  <header>
    <h1>Killy's Munda World <button class="danger" onclick="app.reset()">RESET</button> </h1>
  </header>

  <!-- TABS -->
  <div class="tabs">
    <button class="tab active" onclick="app.switchTab('setup')">SETUP</button>
    <button class="tab" onclick="app.switchTab('battle')">BATTLE</button>
    <button class="tab" onclick="app.switchTab('report')">REPORT</button>
    <button class="tab" onclick="app.switchTab('cheat')">CHEAT SHEET</button>
  </div>

  <!-- CONTENT -->
  <div class="content">
    <!-- SETUP PAGE -->
    <div id="setup-page" class="page active"></div>
    
    <!-- BATTLE PAGE -->
    <div id="battle-page" class="page"></div>
    
    <!-- REPORT PAGE -->
    <div id="report-page" class="page"></div>
    
    <!-- CHEAT SHEET PAGE -->
    <div id="cheat-page" class="page"></div>
  </div>

  <!-- MODAL -->
  <div id="modal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 id="modal-title"></h2>
        <button onclick="app.closeModal()" style="padding: 4px 12px; font-size: 20px;">✖</button>
      </div>
      <div id="modal-body"></div>
    </div>
  </div>

   <!-- Load data first -->
  <script src="data.js"></script>
  
  <script>
    const app = {
      state: {
        myGangId: null,
        mySelected: [],
        oppGangIds: [],
        deckIds: ["normal"],
        tacticIds: [],
        scenarioId: null,
        selectedHirePoolIds: [],
        selectedHireFighterIds: [],
        tracking: {},
        expandedCards: {}
      },

      init() {
        this.load();
        this.render();
      },

      save() {
        localStorage.setItem('necro_steel_v1', JSON.stringify(this.state));
        alert('Saved!');
      },

      load() {
        const saved = localStorage.getItem('necro_steel_v1');
        if (saved) {
          try {
            this.state = JSON.parse(saved);
            this.render();
          } catch (e) {
            console.error('Failed to load', e);
          }
        }
      },

      reset() {
        if (!confirm('Reset all data? This cannot be undone!')) return;
        localStorage.removeItem('necro_steel_v1');
        this.state = {
          myGangId: null,
          mySelected: [],
          oppGangIds: [],
          deckIds: ["normal"],
          tacticIds: [],
          scenarioId: null,
          selectedHirePoolIds: [],
          selectedHireFighterIds: [],
          tracking: {},
          expandedCards: {}
        };
        this.render();
      },

      switchTab(tab) {
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
        
        event.target.classList.add('active');
        document.getElementById(`${tab}-page`).classList.add('active');
        
        this.render();
      },

      openModal(title, body) {
        document.getElementById('modal-title').textContent = title;
        document.getElementById('modal-body').innerHTML = atob(body);
        document.getElementById('modal').classList.add('active');
      },

      closeModal() {
        document.getElementById('modal').classList.remove('active');
      },

      generateBattleOutcome() {
        let creds = document.getElementById('creditsEarned').value || 0;
        let rep = document.getElementById('repEarned').value || 0;
        let resources = document.getElementById('resources').value || 0;
        let victoryCheckbox = document.getElementById('resources').checked || false;
        let victory = 'Defeat'
        if (victoryCheckbox) { victory = 'Victory'}

        return document.getElementById('reportText').value +`\n---BATTLE OUTCOME---
Result: ${victory}
Credits: ${creds}
Reputation: ${rep}
Resources: ${resources}`
      },

      toggleFighter(id) {
        if (this.state.mySelected.includes(id)) {
          this.state.mySelected = this.state.mySelected.filter(x => x !== id);
        } else {
          this.state.mySelected.push(id);
        }
        this.render();
      },

      addRandomFighters() {
        const gang = DATA.gangs.find(g => g.id === this.state.myGangId);
        if (!gang) return;
        const n = parseInt(prompt('How many random fighters?', '3')) || 3;
        const available = gang.fighters.filter(f => !this.state.mySelected.includes(f.id));
        for (let i = 0; i < n && available.length > 0; i++) {
          const idx = Math.floor(Math.random() * available.length);
          this.state.mySelected.push(available[idx].id);
          available.splice(idx, 1);
        }
        this.render();
      },

      toggleOpponent(id) {
        if (this.state.oppGangIds.includes(id)) {
          this.state.oppGangIds = this.state.oppGangIds.filter(x => x !== id);
        } else {
          this.state.oppGangIds.push(id);
        }
        this.render();
      },

      toggleDeck(id) {
        if (this.state.deckIds.includes(id)) {
          this.state.deckIds = this.state.deckIds.filter(x => x !== id);
        } else {
          this.state.deckIds.push(id);
        }
        this.render();
      },

      toggleTactic(id) {
        if (this.state.tacticIds.includes(id)) {
          this.state.tacticIds = this.state.tacticIds.filter(x => x !== id);
        } else {
          this.state.tacticIds.push(id);
        }
        this.render();
      },

      addRandomTactics() {
        const pool = DATA.tactics.decks
          .filter(d => this.state.deckIds.includes(d.id))
          .flatMap(d => d.cards);
        const n = parseInt(prompt('How many random tactics?', '3')) || 3;
        const available = pool.filter(c => !this.state.tacticIds.includes(c.id));
        for (let i = 0; i < n && available.length > 0; i++) {
          const idx = Math.floor(Math.random() * available.length);
          this.state.tacticIds.push(available[idx].id);
          available.splice(idx, 1);
        }
        this.render();
      },

      toggleHirePool(id) {
        if (this.state.selectedHirePoolIds.includes(id)) {
          this.state.selectedHirePoolIds = this.state.selectedHirePoolIds.filter(x => x !== id);
        } else {
          this.state.selectedHirePoolIds.push(id);
        }
        this.render();
      },

      toggleHire(id) {
        if (this.state.selectedHireFighterIds.includes(id)) {
          this.state.selectedHireFighterIds = this.state.selectedHireFighterIds.filter(x => x !== id);
        } else {
          this.state.selectedHireFighterIds.push(id);
        }
        this.render();
      },

      addRandomHires() {
        const pools = DATA.hires.pools.filter(p => this.state.selectedHirePoolIds.includes(p.id));
        const allHires = pools.flatMap(p => p.fighters.map(f => `${p.id}_${f.id}`));
        const n = parseInt(prompt('How many random hires?', '2')) || 2;
        const available = allHires.filter(id => !this.state.selectedHireFighterIds.includes(id));
        for (let i = 0; i < n && available.length > 0; i++) {
          const idx = Math.floor(Math.random() * available.length);
          this.state.selectedHireFighterIds.push(available[idx]);
          available.splice(idx, 1);
        }
        this.render();
      },

      toggleCardExpanded(key) {
        this.state.expandedCards[key] = !this.state.expandedCards[key];
        this.render();
      },

      addXP(key, note, xp) {
        if (!this.state.tracking[key]) {
          this.state.tracking[key] = { xpLog: [], misc: 0, ooa: false, serious: 0, injuryNotes: [], meta: {} };
        }
        this.state.tracking[key].xpLog.push({ note, xp, ts: Date.now() });
        this.render();
      },

      setMiscXP(key, value) {
        if (!this.state.tracking[key]) return;
        this.state.tracking[key].misc = parseInt(value) || 0;
      },

      toggleOoA(key) {
        if (!this.state.tracking[key]) return;
        this.state.tracking[key].ooa = !this.state.tracking[key].ooa;
        this.render();
      },

      addInjury(key, injury) {
        if (!this.state.tracking[key]) return;
        this.state.tracking[key].serious++;
        this.state.tracking[key].injuryNotes.push(`Sustained Injury: ${injury}`);
        this.render();
      },

      clearLog(key) {
        if (!confirm('Clear all events for this fighter?')) return;
        if (!this.state.tracking[key]) return;
        this.state.tracking[key].xpLog = [];
        this.state.tracking[key].injuryNotes = [];
        this.state.tracking[key].misc = 0;
        this.render();
      },

      showOoAModal(key) {
        const enemies = this.state.oppGangIds.flatMap(gid => {
          const g = DATA.gangs.find(x => x.id === gid);
          return g ? g.fighters.map(f => ({ ...f, gangName: g.name })) : [];
        });

        if (enemies.length === 0) {
          alert('No opponent gangs selected!');
          return;
        }

        const body = `
          <p style="margin-bottom:12px;font-weight:700;">Select target taken Out of Action:</p>
          ${enemies.map(f => `
            <button onclick="app.recordOoA('${key}', '${f.name}', '${f.role}')" style="width:100%;margin:4px 0;">
              ${f.name} (${f.role}) - ${f.gangName}
            </button>
          `).join('')}
        `;

        this.openModal('Out of Action', btoa(body));
      },

      recordOoA(key, name, role) {
        let xp = 2;
        if (role === 'Leader' || role === 'Champion') xp = 3;
        this.addXP(key, `Put ${name} (${role}) OoA`, xp);
        this.closeModal();
      },

      

      generateReport() {
        const gang = DATA.gangs.find(g => g.id === this.state.myGangId);
        const scenario = DATA.scenarios.find(s => s.id === this.state.scenarioId);
        
        // Get battle outcome values
        const creditsEarned = document.getElementById('creditsEarned')?.value || 0;
        const repEarned = document.getElementById('repEarned')?.value || 0;
        const resources = document.getElementById('resources')?.value || '';
        const won = document.getElementById('won')?.checked || false;

        let report = '## NECROMUNDA BATTLE REPORT\n\n';

        if (scenario) {
          report += `SCENARIO: ${scenario.name}\n\n`;
        }
        
        if (gang) {
          report += `MY GANG: ${gang.name}\n\n`;
          
          this.state.mySelected.forEach(fid => {
            const f = gang.fighters.find(x => x.id === fid);
            if (!f) return;
            const key = `gang_${fid}`;
            const t = this.state.tracking[key];
            if (!t) return;
            
            const totalXP = t.xpLog.reduce((sum, e) => sum + e.xp, 0) + t.misc;
            report += `${f.name} (${f.role}) - Rating: ${f.rating}\n`;
            report += `  Total XP: ${totalXP}\n`;
            if (t.ooa) report += `  STATUS: OUT OF ACTION\n`;
            report += `  Serious Injuries: ${t.serious}\n`;
            t.xpLog.forEach(e => report += `  - ${e.note} (+${e.xp})\n`);
            if (t.misc > 0) report += `  - Misc XP: +${t.misc}\n`;
            t.injuryNotes.forEach(n => report += `  - ${n}\n`);
            report += '\n';
          });
        };
        
        if (this.state.selectedHireFighterIds.length > 0) {
          report += 'HIRED GUNS:\n\n';
          this.state.selectedHireFighterIds.forEach(hid => {
            const [poolId, fid] = hid.split('_');
            const pool = DATA.hires.pools.find(p => p.id === poolId);
            const f = pool?.fighters.find(x => x.id === fid);
            if (!f) return;
            const key = `hire_${hid}`;
            const t = this.state.tracking[key];
            if (!t) return;
            
            const totalXP = t.xpLog.reduce((sum, e) => sum + e.xp, 0) + t.misc;
            report += `${f.name} (${f.role}) - ${pool.name} - Rating: ${f.rating}\n`;
            report += `  Total XP: ${totalXP}\n`;
            if (t.ooa) report += `  STATUS: OUT OF ACTION\n`;
            report += `  Serious Injuries: ${t.serious}\n`;
            t.xpLog.forEach(e => report += `  - ${e.note} (+${e.xp})\n`);
            if (t.misc > 0) report += `  - Misc XP: +${t.misc}\n`;
            t.injuryNotes.forEach(n => report += `  - ${n}\n`);
            report += '\n';
          });
        }
        
        if (this.state.tacticIds.length > 0) {
          report += 'TACTICS USED:\n';
          this.state.tacticIds.forEach(tid => {
            const c = DATA.tactics.decks.flatMap(d => d.cards.map(x => ({...x, deckName: d.name}))).find(x => x.id === tid);
            if (c) report += `- ${c.name} (${c.deckName})\n`;
          });
          report += '\n';
        }
        
        if (this.state.oppGangIds.length > 0) {
          report += 'OPPONENTS:\n';
          this.state.oppGangIds.forEach(gid => {
            const g = DATA.gangs.find(x => x.id === gid);
            if (g) report += `- ${g.name}\n`;
          });
        }
        
        return report;
      },

      render() {
        this.renderSetup();
        this.renderBattle();
        this.renderReport();
        this.renderCheatSheet();
      },

      renderSetup() {
        const gang = DATA.gangs.find(g => g.id === this.state.myGangId);
        const scenario = DATA.scenarios.find(s => s.id === this.state.scenarioId);
        
        const html = `
          <!-- SCENARIO -->
          <div class="section">
            <h2>SCENARIO</h2>
            <label>Select Scenario:</label>
            <select onchange="app.state.scenarioId = this.value || null; app.render();">
              <option value="">-- Select Scenario --</option>
              ${DATA.scenarios.map(s => `<option value="${s.id}" ${s.id === this.state.scenarioId ? 'selected' : ''}>${s.name}</option>`).join('')}
            </select>
            <button onclick="app.state.scenarioId = DATA.scenarios[Math.floor(Math.random()*DATA.scenarios.length)].id; app.render();" style="margin-top:8px;margin-right:8px;">RANDOM</button>
            <button class="secondary" onclick="app.openModal('${scenario?.name || ''}', '${btoa(scenario?.text) || ''}')" style="margin-top:8px;">DETAILS</button>
            <table style="font-size:12px;">
              <thead>
                <tr><th width="20%">2D6</th><th>Result</th></tr>
              </thead>
              <tbody>
                <tr><td width="20%" style="font-weight:900;background:#d94f2e;color:#fafaf5;">2-3</td><td>The player with the greater number of Structures chooses which scenario to play. If both players have the same number of Structures, the winner of a roll-off chooses which scenario to play. If the scenario dictates there is an attacker and a defender, the player who chooses the scenario is the attacker.</td></tr>
                <tr><td width="20%" style="font-weight:900;background:#d94f2e;color:#fafaf5;">4-5</td><td>Play the Gunk Tank </td></tr>
                <tr><td width="20%" style="font-weight:900;background:#d94f2e;color:#fafaf5;">6-7</td><td>Play the Mining Expedition</td></tr>
                <tr><td width="20%" style="font-weight:900;background:#d94f2e;color:#fafaf5;">8-9</td><td>Play the The Big Score</td></tr>
                <tr><td width="20%" style="font-weight:900;background:#d94f2e;color:#fafaf5;">10-12</td><td>The player with fewer Structures chooses which scenario to play. If both players have the same number of Structures, the winner of a roll-off chooses which scenario to play. If the scenario dictates there is an attacker and a defender, the player who chooses the scenario is the attacker.</td></tr>
              </tbody>
            </table>
          </div>

          <!-- MY GANG -->
          <div class="section">
            <h2>MY GANG</h2>
            <label>Select Gang:</label>
            <select onchange="app.state.myGangId = this.value || null; app.state.mySelected = []; app.render();">
              <option value="">-- Select Gang --</option>
              ${DATA.gangs.map(g => `<option value="${g.id}" ${g.id === this.state.myGangId ? 'selected' : ''}>${g.name}</option>`).join('')}
            </select>
            
            ${gang ? `
              <div style="display:flex;gap:8px;flex-wrap:wrap;margin:12px 0;">
                <span class="chip">Selected: ${this.state.mySelected.length}</span>
                <span class="chip">Rating: ${this.state.mySelected.reduce((sum,id) => sum+(gang.fighters.find(f=>f.id===id)?.rating||0),0)}</span>
              </div>
              
              <table>
                <thead>
                  <tr><th style="width:15%">Select</th><th style="width:40%">Name</th><th style="width:25%">Role</th><th style="width:20%">Rating</th></tr>
                </thead>
                <tbody>
                  ${gang.fighters.map(f => `
                    <tr>
                      <td><input type="checkbox" ${this.state.mySelected.includes(f.id) ? 'checked' : ''} onchange="app.toggleFighter('${f.id}')"></td>
                      <td>${f.name}</td>
                      <td>${f.role}</td>
                      <td>${f.rating}</td>
                    </tr>
                  `).join('')}
                </tbody>
              </table>
              
              <button class="success" onclick="app.addRandomFighters()" style="margin-right:8px;">ADD RANDOM</button>
              <button class="danger" onclick="app.state.mySelected = []; app.render();">CLEAR</button>
            ` : ''}
          </div>

          <!-- OPPONENTS -->
          <div class="section" style="background: var(--red)">
            <h2>OPPONENT GANGS</h2>
            ${DATA.gangs.map(g => `
              <label class="checkbox-label">
                <input type="checkbox" ${this.state.oppGangIds.includes(g.id) ? 'checked' : ''} onchange="app.toggleOpponent('${g.id}')">
                <strong>${g.name}</strong>
              </label>
            `).join('')}
          </div>

          <!-- TACTICS -->
          <div class="section" style="background: var(--green)">
            <h2>TACTICS</h2>
            <label>Select Decks:</label>
            ${DATA.tactics.decks.map(d => `
              <label class="checkbox-label">
                <input type="checkbox" ${this.state.deckIds.includes(d.id) ? 'checked' : ''} onchange="app.toggleDeck('${d.id}')">
                <strong>${d.name}</strong>
              </label>
            `).join('')}
            
            ${this.state.deckIds.length > 0 ? `
              <table>
                <thead>
                  <tr><th style="width:15%">Select</th><th style="width:40%">Card</th><th style="width:30%">Deck</th><th style="width:15%">View</th></tr>
                </thead>
                <tbody>
                  ${DATA.tactics.decks
                    .filter(d => this.state.deckIds.includes(d.id))
                    .flatMap(d => d.cards.map(c => ({...c, deckName: d.name})))
                    .map(c => `
                      <tr>
                        <td style="width:15%" ><input type="checkbox" ${this.state.tacticIds.includes(c.id) ? 'checked' : ''} onchange="app.toggleTactic('${c.id}')"></td>
                        <td>${c.name}</td>
                        <td>${c.deckName}</td>
                        <td><button onclick="app.openModal('${c.name}', '${btoa(c.text)}')" style="padding:4px 8px;font-size:12px;">VIEW</button></td>
                      </tr>
                    `).join('')}
                </tbody>
              </table>
              
              <button class="toxic" onclick="app.addRandomTactics()" style="margin-right:8px;">ADD RANDOM</button>
              <button class="danger" onclick="app.state.tacticIds = []; app.render();">CLEAR</button>
            ` : ''}
          </div>
        `;
        
        document.getElementById('setup-page').innerHTML = html;
      },

      renderBattle() {
        const gang = DATA.gangs.find(g => g.id === this.state.myGangId);
        
        let html = `
          <!-- TACTICS IN PLAY -->
          <div class="tactics-panel">
            <h3>TACTICS IN PLAY</h3>
            <div>
              ${this.state.tacticIds.length > 0 ? this.state.tacticIds.map(tid => {
                const c = DATA.tactics.decks.flatMap(d => d.cards).find(x => x.id === tid);
                return c ? `<span class="chip" style="cursor:pointer;" onclick="app.openModal('${c.name}', '${btoa(c.text)}')">${c.name}</span>` : '';
              }).join('') : '<span class="chip">None selected</span>'}
            </div>
          </div>
        `;
        
        if (gang) {
          const gangFighters = this.state.mySelected.map(fid => {
            const f = gang.fighters.find(x => x.id === fid);
            if (!f) return null;
            const key = `gang_${fid}`;
            if (!this.state.tracking[key]) {
              this.state.tracking[key] = { xpLog: [], misc: 0, ooa: false, serious: 0, injuryNotes: [], meta: { type: 'gang' } };
            }
            return { ...f, key, source: gang.name };
          }).filter(Boolean);

          const hireFighters = this.state.selectedHireFighterIds.map(hid => {
            const [poolId, fid] = hid.split('_');
            const pool = DATA.hires.pools.find(p => p.id === poolId);
            const f = pool?.fighters.find(x => x.id === fid);
            if (!f) return null;
            const key = `hire_${hid}`;
            if (!this.state.tracking[key]) {
              this.state.tracking[key] = { xpLog: [], misc: 0, ooa: false, serious: 0, injuryNotes: [], meta: { type: 'hire', poolId } };
            }
            return { ...f, key, source: `Hire: ${pool.name}` };
          }).filter(Boolean);

          const allFighters = [...gangFighters, ...hireFighters];

          allFighters.forEach(f => {
            const t = this.state.tracking[f.key] || { xpLog: [], misc: 0, ooa: false, serious: 0, injuryNotes: [], meta: {} };
            const totalXP = t.xpLog.reduce((sum, e) => sum + e.xp, 0) + t.misc;
            const isExpanded = this.state.expandedCards[f.key];

            html += `
              <div class="fighter-card ${t.ooa ? 'ooa' : ''} ${!isExpanded ? 'collapsed' : ''}" onclick="if(event.target.tagName !== 'BUTTON' && event.target.tagName !== 'INPUT' && event.target.tagName !== 'SELECT') app.toggleCardExpanded('${f.key}')">
                ${!isExpanded ? `
                  <div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:8px;">
                    <div>
                      <h3 style="font-size:18px;font-weight:900;text-transform:uppercase;margin-bottom:4px;">${f.name}</h3>
                      <div style="display:flex;gap:4px;flex-wrap:wrap;">
                        <span class="chip" style="font-size:10px;padding:4px 8px;">${f.role}</span>
                        <span class="chip" style="font-size:10px;padding:4px 8px;">XP: ${totalXP}</span>
                        ${t.ooa ? '<span class="chip" style="background:#ff3838;font-size:10px;padding:4px 8px;">OOA</span>' : ''}
                      </div>
                    </div>
                    <div style="font-size:24px;font-weight:900;color:${t.ooa?'#fafaf5':'#0a0a0a'};">▼</div>
                  </div>
                ` : `
                  <div style="display:flex;justify-content:space-between;align-items:flex-start;">
                    <h3 style="font-size:18px;font-weight:900;margin-bottom:12px;text-transform:uppercase;border-bottom:3px solid #0a0a0a;padding-bottom:8px;flex:1;">${f.name}</h3>
                    <div style="font-size:24px;font-weight:900;margin-left:12px;color:${t.ooa?'#fafaf5':'#0a0a0a'};">▲</div>
                  </div>
                  
                  <div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:12px;">
                    <span class="chip">${f.role}</span>
                    <span class="chip">${f.source}</span>
                    <span class="chip">Rating: ${f.rating}</span>
                    <span class="chip">XP: ${totalXP}</span>
                    <span class="chip">Serious: ${t.serious}</span>
                    ${t.ooa ? '<span class="chip" style="background:#ff3838;">OUT OF ACTION</span>' : ''}
                  </div>
                  
                  <div class="button-grid" onclick="event.stopPropagation();">
                    <button class="success" onclick="app.addXP('${f.key}','Serious Injury Caused',1)">+1 SERIOUS INJ</button>
                    <button class="success" onclick="app.addXP('${f.key}','Vehicle Wrecked',2)">+2 VEHICLE</button>
                    <button class="danger" onclick="app.showOoAModal('${f.key}')">+2 OUT OF ACTION</button>
                    <button class="secondary" onclick="app.addXP('${f.key}','Took Part',1)">+1 TOOK PART</button>
                    <button class="secondary" onclick="app.addXP('${f.key}','Rally',1)">+1 RALLY</button>
                    <button class="secondary" onclick="app.addXP('${f.key}','Assist Recovery',1)">+1 ASSIST</button>
                  </div>
                  
                  <div onclick="event.stopPropagation();">
                    <label style="display:block;font-weight:700;margin-top:12px;text-transform:uppercase;">Misc XP:</label>
                    <input type="number" value="${t.misc}" onchange="app.setMiscXP('${f.key}', this.value); app.render();" style="width:100%;padding:10px;border:4px solid #0a0a0a;background:#fafaf5;font-family:inherit;font-size:14px;margin-bottom:8px;box-shadow:3px 3px 0 #0a0a0a;">
                    
                    <div style="margin:12px 0;">
                      <label style="display:block;font-weight:700;text-transform:uppercase;">Add Lasting Injury:</label>
                      <select id="injury_${f.key}" style="width:100%;padding:10px;border:4px solid #0a0a0a;background:#fafaf5;font-family:inherit;font-size:14px;margin-bottom:8px;box-shadow:3px 3px 0 #0a0a0a;">
                        ${DATA.injuries.map(inj => `<option value="${inj}">${inj}</option>`).join('')}
                      </select>
                      <button class="danger" onclick="app.addInjury('${f.key}', document.getElementById('injury_${f.key}').value)" style="margin-top:8px;">ADD INJURY</button>
                    </div>
                    
                    <button class="${t.ooa ? 'success' : 'danger'}" onclick="app.toggleOoA('${f.key}')" style="margin-right:8px;margin-top:8px;">
                      ${t.ooa ? '✓ REVIVE' : 'MARK OOA'}
                    </button>
                    <button class="danger" onclick="app.clearLog('${f.key}')" style="margin-top:8px;">CLEAR LOG</button>
                    
                    <div class="log">
                      ${t.xpLog.map(e => `<div class="log-entry">${e.note} (+${e.xp} XP)</div>`).join('')}
                      ${t.injuryNotes.map(n => `<div class="log-entry" style="color:${t.ooa?'#fafaf5':'#ff3838'};">${n}</div>`).join('')}
                      ${t.xpLog.length === 0 && t.injuryNotes.length === 0 ? '<div class="log-entry">No events yet</div>' : ''}
                    </div>
                  </div>
                `}
              </div>
            `;
          });
        }
        
        html += `
          <div class="section">
            <h2>D66 LASTING INJURY TABLE</h2>
            <table style="font-size:12px;">
              <thead>
                <tr><th width="20%">D66</th><th>Result</th></tr>
              </thead>
              <tbody>
                <tr><td width="20%" style="font-weight:900;background:#d94f2e;color:#fafaf5;">11-26</td><td>Out Cold: Miss next game</td></tr>
                <tr><td width="20%" style="font-weight:900;background:#d94f2e;color:#fafaf5;">31-35</td><td>Convalescence: Miss D3 games</td></tr>
                <tr><td width="20%" style="font-weight:900;background:#d94f2e;color:#fafaf5;">36</td><td>Humiliated: -1 XP</td></tr>
                <tr><td width="20%" style="font-weight:900;background:#d94f2e;color:#fafaf5;">41-45</td><td>Head Injury: -1 Intelligence</td></tr>
                <tr><td width="20%" style="font-weight:900;background:#d94f2e;color:#fafaf5;">46</td><td>Eye Injury: -1 BS</td></tr>
                <tr><td width="20%" style="font-weight:900;background:#d94f2e;color:#fafaf5;">51</td><td>Hand Injury: -1 WS</td></tr>
                <tr><td width="20%" style="font-weight:900;background:#d94f2e;color:#fafaf5;">52-53</td><td>Hobbled: -1 Movement</td></tr>
                <tr><td width="20%" style="font-weight:900;background:#d94f2e;color:#fafaf5;">54</td><td>Spinal Injury: -1 Strength</td></tr>
                <tr><td width="20%" style="font-weight:900;background:#d94f2e;color:#fafaf5;">55</td><td>Enfeebled: -1 Toughness</td></tr>
                <tr><td width="20%" style="font-weight:900;background:#d94f2e;color:#fafaf5;">56</td><td>Partially Deafened: -1 Cool/Willpower</td></tr>
                <tr><td width="20%" style="font-weight:900;background:#d94f2e;color:#fafaf5;">61-65</td><td>Multiple Injuries: Roll twice</td></tr>
                <tr><td width="20%" style="font-weight:900;background:#d94f2e;color:#fafaf5;">66</td><td>Memorable Death: Remove from roster</td></tr>
              </tbody>
            </table>
          </div>
        `;
        
        document.getElementById('battle-page').innerHTML = html;
      },

      renderReport() {
        const report = this.generateReport();

        const tempBody = `<!-- Battle Outcome Inputs -->
          <div class="section" style="background: var(--purple);">
            <h2 style="color: var(--yellow);">BATTLE OUTCOME</h2>
            
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px; margin-bottom: 12px;">
              <div>
                <label style="color: var(--white);">Credits Earned:</label>
                <input type="number" id="creditsEarned" value="0" style="width: 100%;">
              </div>
              
              <div>
                <label style="color: var(--white);">Rep Earned:</label>
                <input type="number" id="repEarned" value="0" style="width: 100%;">
              </div>

              <div>
                <label style="color: var(--white);">Resources:</label>
                <input type="text" id="resources" placeholder="e.g., Captured territory, found loot..." style="width: 100%;">
              </div>
            </div>
            
            <label class="checkbox-label" style="background: rgba(255,255,255,0.1); color: var(--white);">
              <input type="checkbox" id="won">
              <strong style="font-size: 16px;">VICTORY</strong>
            </label>

            <button onclick="navigator.clipboard.writeText(app.generateBattleOutcome()).then(() => alert('Report copied!'))">Copy</button>
          </div>`
        
        const html = `
          <div class="section">
            <h2>BATTLE REPORT</h2>
            <button onclick="app.openModal('Wrap up', '${btoa(tempBody)}')">Generate Report</button>
            <textarea id="reportText" rows="30" style="width:100%;padding:10px;border:4px solid #0a0a0a;background:#fafaf5;font-family:monospace;font-size:14px;margin-top:12px;box-shadow:3px 3px 0 #0a0a0a;" readonly>${report}</textarea>
          </div>
        `;
        
        document.getElementById('report-page').innerHTML = html;
      },

      renderCheatSheet() {
        const html = `
          <div class="section">
            <h2>PHASE SEQUENCE</h2>
            <table>
              <thead>
                <tr><th style="width=20%">Phase</th><th>Effect</th></tr>
              </thead>
              <tbody>
                <tr><td style="width=20%">Priority</td><td>Roll for priority; Tie surrenders priority to player who did not have it last round.</td></tr>
                <tr><td style="width=20%">Action</td><td>Alternate turns activating fighters.</td></tr>
                <tr><td style="width=20%">End Phase</td><td>Bottle Checks, Fleeing the Battlefield, Recover & Restart, and Rally Tests </td></tr>
              </tbody>
            </table>
          </div>

          <div class="section">
            <h2>ACTIONS</h2>
            <p><b style="background: var(--cyan)">Simple</b>(More than once per activations) <br/><b style="background: var(--green)">Basic</b>(Once per activation) <br/><b style="background: var(--red)">Double</b>(Consumes 2 actions; Also once per activation)</p>
            <table>
              <thead>
                <tr><th>Action</th><th>Effect</th></tr>
              </thead>
              <tbody>
                <tr>
                  <td style="width:20%; background: var(--cyan)">Move</td>
                  <td>
                    <ul style="padding-left: 10px;">
                      <li>Move a distance up to their Movement characteristic.</li>
                      <li>Climb vertically upwards or downwards.</li>
                      <li>Cross any gap between two platforms that is no wider than their base.</li>
                      <li>Attempt to leap across a bigger gap provided that they have enough movement left to do so.</li>
                      <li>Attempt to jump down to a level below.</li>
                    </ul>
                  </td>
                </tr>
                <tr>
                  <td style="width:20%; background: var(--red)">Charge</td>
                  <td>
                    The fighter moves as if making a Move (Simple) action, but adds D3" to the distance they can move. A charging fighter can move to within 1" of one or more enemy fighters that are Standing and either Active or Engaged, or that are Prone and either Pinned or Seriously Injured, but if they do move to within 1" they must have sufficient movement to get into base to base contact with at least one enemy fighter. If they do not have sufficient movement to get into base to base contact, they must stop 1" away. If they are Standing and Engaged at the end of this move, they must immediately make a free Fight (Basic) action. If they are Standing and Engaged with a Prone and Pinned fighter at the end of this move, that fighter changes their status to Standing and Active.
                  </td>
                </tr>

              </tbody>
            </table>
          </div>
        `;
        
        document.getElementById('cheat-page').innerHTML = html;
      }
    };

    // Initialize on load
    document.addEventListener('DOMContentLoaded', () => app.init());
  </script>
</body>
</html>