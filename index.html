<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>NECROMUNDA | STEEL TRACKER</title>
  <style>
    /* === RESET === */
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    /* === NEO-BRUTALISM POST-APOCALYPTIC === */
    :root {
      --black: #0a0a0a;
      --white: #fafaf5;
      --red: #ff3838;
      --orange: #ff8c38;
      --yellow: #ffd438;
      --green: #38ff88;
      --cyan: #38d4ff;
      --purple: #b838ff;
      --gray: #666666;
      --rust: #d94f2e;
      --toxic: #c7ff00;
      --steel: #8b9aa8;
    }
    
    body {
      font-family: 'Courier New', monospace;
      background: var(--white);
      color: var(--black);
      line-height: 1.5;
      padding-bottom: 60px;
    }
    
    /* === HEADER === */
    header {
      background: var(--red);
      border-bottom: 4px solid var(--black);
      padding: 12px;
      position: sticky;
      top: 0;
      z-index: 100;
      box-shadow: 0 4px 0 var(--black);
    }
    
    h1 {
      font-size: 24px;
      font-weight: 900;
      text-transform: uppercase;
      letter-spacing: 2px;
      margin-bottom: 8px;
    }
    
    .header-actions {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }
    
    /* === BUTTONS === */
    button, .btn {
      background: var(--yellow);
      color: var(--black);
      border: 4px solid var(--black);
      padding: 10px 16px;
      font-family: inherit;
      font-size: 14px;
      font-weight: 700;
      text-transform: uppercase;
      cursor: pointer;
      box-shadow: 4px 4px 0 var(--black);
      transition: transform 0.1s, box-shadow 0.1s;
      white-space: nowrap;
    }
    
    button:hover, .btn:hover {
      transform: translate(2px, 2px);
      box-shadow: 2px 2px 0 var(--black);
    }
    
    button:active, .btn:active {
      transform: translate(4px, 4px);
      box-shadow: none;
    }
    
    button.danger { background: var(--red); color: var(--white); }
    button.success { background: var(--green); }
    button.secondary { background: var(--steel); color: var(--white); }
    button.toxic { background: var(--toxic); }
    
    /* === TABS === */
    .tabs {
      display: flex;
      background: var(--orange);
      border-bottom: 4px solid var(--black);
      overflow-x: auto;
    }
    
    .tab {
      flex: 1;
      min-width: 100px;
      padding: 12px 8px;
      background: var(--gray);
      color: var(--white);
      border: none;
      border-right: 4px solid var(--black);
      font-weight: 900;
      box-shadow: none;
    }
    
    .tab:last-child { border-right: none; }
    .tab.active { background: var(--orange); color: var(--black); }
    
    /* === CONTENT === */
    .content {
      padding: 16px;
      max-width: 1200px;
      margin: 0 auto;
    }
    
    .page { display: none; }
    .page.active { display: block; }
    
    .section {
      background: var(--cyan);
      border: 4px solid var(--black);
      padding: 16px;
      margin-bottom: 20px;
      box-shadow: 6px 6px 0 var(--black);
      transform: rotate(-0.5deg);
    }
    
    .section:nth-child(even) { transform: rotate(0.5deg); background: var(--yellow); }
    .section:nth-child(3n) { background: var(--green); }
    
    h2 {
      font-size: 20px;
      font-weight: 900;
      text-transform: uppercase;
      margin-bottom: 12px;
      text-decoration: underline;
      text-decoration-thickness: 3px;
    }
    
    /* === FORM ELEMENTS === */
    select, input[type="number"], textarea {
      width: 100%;
      padding: 10px;
      border: 4px solid var(--black);
      background: var(--white);
      font-family: inherit;
      font-size: 14px;
      margin-bottom: 8px;
      box-shadow: 3px 3px 0 var(--black);
    }
    
    label {
      display: block;
      font-weight: 700;
      margin-bottom: 4px;
      text-transform: uppercase;
    }
    
    .checkbox-label {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 12px;
      background: rgba(0,0,0,0.05);
      border: 3px solid var(--black);
      margin: 8px 0;
      cursor: pointer;
      transition: all 0.1s;
    }
    
    .checkbox-label:hover {
      background: rgba(0,0,0,0.1);
      transform: translate(1px, 1px);
    }
    
    .checkbox-label input[type="checkbox"] {
      width: 20px;
      height: 20px;
      cursor: pointer;
      flex-shrink: 0;
    }
    
    /* === TABLE === */
    table {
      width: 100%;
      border-collapse: separate;
      border-spacing: 0;
      border: 4px solid var(--black);
      background: var(--white);
      margin: 12px 0;
      box-shadow: 6px 6px 0 var(--black);
      overflow-x: auto;
      display: block;
    }
    
    table thead, table tbody, table tr {
      display: table;
      width: 100%;
      table-layout: fixed;
    }
    
    th {
      background: var(--black);
      color: var(--yellow);
      padding: 10px;
      text-align: left;
      border-bottom: 4px solid var(--black);
      font-weight: 900;
      text-transform: uppercase;
      font-size: 12px;
    }
    
    td {
      padding: 10px;
      border-bottom: 3px solid var(--black);
      font-size: 13px;
      word-wrap: break-word;
    }
    
    tr:last-child td { border-bottom: none; }
    tbody tr:hover { background: var(--yellow); }
    
    /* === CHIP === */
    .chip {
      background: var(--purple);
      color: var(--white);
      padding: 6px 12px;
      border: 3px solid var(--black);
      font-weight: 700;
      font-size: 12px;
      box-shadow: 3px 3px 0 var(--black);
      text-transform: uppercase;
      display: inline-block;
      margin: 4px;
    }
    
    /* === FIGHTER CARD === */
    .fighter-card {
      background: var(--white);
      border: 4px solid var(--black);
      padding: 16px;
      margin-bottom: 16px;
      box-shadow: 10px 10px 0 var(--black);
      transform: rotate(-1deg);
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .fighter-card:nth-child(even) { transform: rotate(1deg); }
    .fighter-card.ooa { background: var(--rust); color: var(--white); }
    .fighter-card.collapsed { padding: 12px 16px; }
    .fighter-card:hover { transform: rotate(0deg) scale(1.01); }
    
    /* === LOG === */
    .log {
      background: var(--white);
      border: 4px solid var(--black);
      padding: 12px;
      margin: 12px 0;
      max-height: 200px;
      overflow-y: auto;
      font-size: 12px;
      box-shadow: 3px 3px 0 var(--black);
    }
    
    .log-entry {
      padding: 4px 0;
      border-bottom: 2px dashed var(--gray);
    }
    
    /* === MODAL === */
    .modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.9);
      z-index: 1000;
      padding: 20px;
      overflow-y: auto;
      display: none;
      align-items: center;
      justify-content: center;
    }
    
    .modal.active { display: flex; }
    
    .modal-content {
      background: var(--cyan);
      border: 4px solid var(--black);
      padding: 24px;
      max-width: 600px;
      width: 100%;
      box-shadow: 10px 10px 0 var(--black);
      max-height: 90vh;
      overflow-y: auto;
    }
    
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
      border-bottom: 3px solid var(--black);
      padding-bottom: 12px;
    }
    
    .modal-header h2 {
      font-size: 20px;
      font-weight: 900;
      text-transform: uppercase;
      margin: 0;
    }
    
    /* === TACTICS PANEL === */
    .tactics-panel {
      background: var(--purple);
      border: 4px solid var(--black);
      padding: 12px;
      margin-bottom: 20px;
      box-shadow: 6px 6px 0 var(--black);
    }
    
    .tactics-panel h3 {
      color: var(--yellow);
      margin-bottom: 8px;
      font-weight: 900;
      text-transform: uppercase;
    }
    
    /* === GRID === */
    .button-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 8px;
      margin: 12px 0;
    }
    
    .button-grid button {
      font-size: 11px;
      padding: 8px;
    }
    
    /* === MOBILE === */
    @media (max-width: 640px) {
      button, .btn {
        font-size: 12px;
        padding: 8px 12px;
      }
      
      th, td {
        padding: 6px;
        font-size: 11px;
      }
      
      .fighter-card {
        transform: rotate(0deg) !important;
      }
      
      .section {
        transform: rotate(0deg) !important;
      }
      
      h1 {
        font-size: 20px;
      }
      
      h2 {
        font-size: 18px;
      }
    }
  </style>
</head>
<body>
  <!-- HEADER -->
  <header>
    <h1>Killy's Munda World <button class="danger" onclick="app.reset()">🔥 RESET</button> </h1>
  </header>

  <!-- TABS -->
  <div class="tabs">
    <button class="tab active" onclick="app.switchTab('setup')">SETUP</button>
    <button class="tab" onclick="app.switchTab('battle')">BATTLE</button>
    <button class="tab" onclick="app.switchTab('report')">REPORT</button>
    <button class="tab" onclick="app.switchTab('cheat')">CHEAT SHEET</button>
  </div>

  <!-- CONTENT -->
  <div class="content">
    <!-- SETUP PAGE -->
    <div id="setup-page" class="page active"></div>
    
    <!-- BATTLE PAGE -->
    <div id="battle-page" class="page"></div>
    
    <!-- REPORT PAGE -->
    <div id="report-page" class="page"></div>
    
    <!-- CHEAT SHEET PAGE -->
    <div id="cheat-page" class="page"></div>
  </div>

  <!-- MODAL -->
  <div id="modal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 id="modal-title"></h2>
        <button onclick="app.closeModal()" style="padding: 4px 12px; font-size: 20px;">✖</button>
      </div>
      <div id="modal-body"></div>
    </div>
  </div>

  <script>
    const DATA = {
      gangs: [
        {
          id: "goliath",
          name: "Goliath",
          fighters: [
            {id:"g_lead",name:"Goliath Leader",role:"Leader",rating:150},
            {id:"g_champ1",name:"Goliath Champion",role:"Champion",rating:110},
            {id:"g_champ2",name:"Stimmer",role:"Champion",rating:115},
            {id:"g_ganger1",name:"Goliath Ganger",role:"Ganger",rating:60},
            {id:"g_ganger2",name:"Goliath Ganger",role:"Ganger",rating:60},
            {id:"g_juve",name:"Goliath Juve",role:"Juve",rating:35}
          ]
        },
        {
          id: "escher",
          name: "Escher",
          fighters: [
            {id:"e_lead",name:"Escher Queen",role:"Leader",rating:145},
            {id:"e_champ1",name:"Escher Champion",role:"Champion",rating:105},
            {id:"e_champ2",name:"Death-Maiden",role:"Champion",rating:120},
            {id:"e_ganger1",name:"Escher Ganger",role:"Ganger",rating:55},
            {id:"e_ganger2",name:"Escher Ganger",role:"Ganger",rating:55},
            {id:"e_juve",name:"Little Sister",role:"Juve",rating:30}
          ]
        },
        {
          id: "orlock",
          name: "Orlock",
          fighters: [
            {id:"o_lead",name:"Road Boss",role:"Leader",rating:140},
            {id:"o_champ1",name:"Road Sergeant",role:"Champion",rating:100},
            {id:"o_champ2",name:"Arms Master",role:"Champion",rating:105},
            {id:"o_ganger1",name:"Gunner",role:"Ganger",rating:65},
            {id:"o_ganger2",name:"Orlock Ganger",role:"Ganger",rating:55},
            {id:"o_juve",name:"Greenhorn",role:"Juve",rating:30}
          ]
        },
        {
          id: "van_saar",
          name: "Van Saar",
          fighters: [
            {id:"v_lead",name:"Van Saar Prime",role:"Leader",rating:155},
            {id:"v_champ1",name:"Augmek",role:"Champion",rating:115},
            {id:"v_champ2",name:"Archeotek",role:"Champion",rating:120},
            {id:"v_ganger1",name:"Van Saar Tek",role:"Ganger",rating:70},
            {id:"v_ganger2",name:"Van Saar Ganger",role:"Ganger",rating:60},
            {id:"v_juve",name:"Van Saar Juve",role:"Juve",rating:35}
          ]
        },
        {
          id: "cawdor",
          name: "Cawdor",
          fighters: [
            {id:"c_lead",name:"Word-Keeper",role:"Leader",rating:135},
            {id:"c_champ1",name:"Cawdor Champion",role:"Champion",rating:95},
            {id:"c_champ2",name:"Sheen Bird",role:"Champion",rating:100},
            {id:"c_ganger1",name:"Cawdor Ganger",role:"Ganger",rating:50},
            {id:"c_ganger2",name:"Bonepicker",role:"Ganger",rating:45},
            {id:"c_juve",name:"Cawdor Juve",role:"Juve",rating:25}
          ]
        },
        {
          id: "delaque",
          name: "Delaque",
          fighters: [
            {id:"d_lead",name:"Master of Shadow",role:"Leader",rating:150},
            {id:"d_champ1",name:"Phantom",role:"Champion",rating:110},
            {id:"d_champ2",name:"Nacht-Ghul",role:"Champion",rating:115},
            {id:"d_ganger1",name:"Shadow",role:"Ganger",rating:60},
            {id:"d_ganger2",name:"Delaque Ganger",role:"Ganger",rating:55},
            {id:"d_juve",name:"Ghost",role:"Juve",rating:30}
          ]
        }
      ],
      tactics: {
        decks: [
          {
            id: "normal",
            name: "Normal Deck",
            cards: [
              {id:"t_overwatch",name:"Overwatch",text:"Reaction. When an enemy fighter moves within LoS, interrupt and make a ranged attack at -1 to hit."},
              {id:"t_ambush",name:"Ambush",text:"Play at start of round. One fighter can make a free Shoot action before Priority roll."},
              {id:"t_evade",name:"Evade",text:"Reaction. When targeted by ranged attack, roll Initiative. Success: attacker suffers -1 to hit."},
              {id:"t_medicae",name:"Medicae",text:"Action. Remove a Flesh Wound from a friendly fighter within 3\"."},
              {id:"t_smoke",name:"Smoke Grenades",text:"Action. Place 5\" smoke template within 6\". Blocks LoS until End Phase."},
              {id:"t_retreat",name:"Tactical Withdrawal",text:"Reaction. When bottled, one fighter may make free Move action toward table edge."}
            ]
          },
          {
            id: "underdog",
            name: "Underdog Deck",
            cards: [
              {id:"t_scavenge",name:"Scavenge",text:"Start of battle. Gain D3 random equipment items from common list."},
              {id:"t_rad",name:"Rad Pulse",text:"Action. Place 3\" blast within 12\". All fighters take S3 hit ignoring armor."},
              {id:"t_desperate",name:"Desperate Measures",text:"Play when making injury roll. Add +1 to the roll."},
              {id:"t_booby",name:"Booby Trap",text:"Deploy phase. Place marker in terrain. First enemy within 2\" takes S4 D2 hit."}
            ]
          },
          {
            id: "dominance",
            name: "Dominance Deck",
            cards: [
              {id:"t_suppression",name:"Suppression Fire",text:"Action. Pin D3 enemy fighters within 18\" and LoS."},
              {id:"t_coordinate",name:"Coordinated Strike",text:"Play before activation. Up to 3 friendly fighters can activate together."},
              {id:"t_ruthless",name:"Ruthless Efficiency",text:"Play when taking fighter OoA. Gain +1 Rep for scenario."}
            ]
          }
        ]
      },
      scenarios: [
        {id:"s_standoff",name:"Stand-off",text:"Standard battle. Control objectives. Winner: most fighters within 6\" of center at end."},
        {id:"s_ambush",name:"Ambush",text:"Defender deploys first. Attacker enters from random edge. Kill/rout enemy to win."},
        {id:"s_skirmish",name:"Skirmish",text:"Random deployment. First blood scenario. First gang to take 3 enemies OoA wins."},
        {id:"s_salvage",name:"Salvage Operation",text:"5 loot markers. Carry off table edge. Gang with most loot wins."},
        {id:"s_sabotage",name:"Sabotage",text:"Attacker must destroy 3 objectives in enemy territory. Defender prevents."},
        {id:"s_tunnel",name:"Tunnel Skirmish",text:"Tight corridors. No long range. Close combat favored. Bottle test at 50%."}
      ],
      hires: {
        pools: [
          {
            id: "bounty",
            name: "Bounty Hunters",
            fighters: [
              {id:"bh_kara",name:"Kara Nine-Fingers",role:"Bounty Hunter",rating:160},
              {id:"bh_slate",name:"Slate Merdena",role:"Bounty Hunter",rating:155},
              {id:"bh_yar",name:"Yar Umbra",role:"Bounty Hunter",rating:165}
            ]
          },
          {
            id: "hired",
            name: "Hired Guns",
            fighters: [
              {id:"hg_rogue",name:"Rogue Doc",role:"Hired Gun",rating:90},
              {id:"hg_dome",name:"Dome Runner",role:"Hired Gun",rating:85},
              {id:"hg_hive",name:"Hive Scum",role:"Hired Gun",rating:70}
            ]
          },
          {
            id: "hangers",
            name: "Hangers-on",
            fighters: [
              {id:"ho_ammo",name:"Ammo-Jack",role:"Hanger-on",rating:40},
              {id:"ho_sloppo",name:"Slopper",role:"Hanger-on",rating:35}
            ]
          }
        ]
      },
      injuries: [
        "Flesh Wound",
        "Concussion",
        "Grievous Injury",
        "Critical Injury",
        "Old Battle Wound",
        "Hobbled",
        "Enfeebled",
        "Partially Deafened",
        "Hand Injury",
        "Head Injury",
        "Eye Injury",
        "Chest Wound",
        "Spinal Injury",
        "Leg Injury",
        "Arm Injury"
      ]
    };

    const app = {
      state: {
        myGangId: null,
        mySelected: [],
        oppGangIds: [],
        deckIds: ["normal"],
        tacticIds: [],
        scenarioId: null,
        selectedHirePoolIds: [],
        selectedHireFighterIds: [],
        tracking: {},
        expandedCards: {}
      },

      init() {
        this.load();
        this.render();
      },

      save() {
        localStorage.setItem('necro_steel_v1', JSON.stringify(this.state));
        alert('Saved!');
      },

      load() {
        const saved = localStorage.getItem('necro_steel_v1');
        if (saved) {
          try {
            this.state = JSON.parse(saved);
            this.render();
          } catch (e) {
            console.error('Failed to load', e);
          }
        }
      },

      reset() {
        if (!confirm('Reset all data? This cannot be undone!')) return;
        localStorage.removeItem('necro_steel_v1');
        this.state = {
          myGangId: null,
          mySelected: [],
          oppGangIds: [],
          deckIds: ["normal"],
          tacticIds: [],
          scenarioId: null,
          selectedHirePoolIds: [],
          selectedHireFighterIds: [],
          tracking: {},
          expandedCards: {}
        };
        this.render();
      },

      switchTab(tab) {
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
        
        event.target.classList.add('active');
        document.getElementById(`${tab}-page`).classList.add('active');
        
        this.render();
      },

      openModal(title, body) {
        document.getElementById('modal-title').textContent = title;
        document.getElementById('modal-body').innerHTML = decodeURIComponent(body);
        document.getElementById('modal').classList.add('active');
      },

      closeModal() {
        document.getElementById('modal').classList.remove('active');
      },

      toggleFighter(id) {
        if (this.state.mySelected.includes(id)) {
          this.state.mySelected = this.state.mySelected.filter(x => x !== id);
        } else {
          this.state.mySelected.push(id);
        }
        this.render();
      },

      addRandomFighters() {
        const gang = DATA.gangs.find(g => g.id === this.state.myGangId);
        if (!gang) return;
        const n = parseInt(prompt('How many random fighters?', '3')) || 3;
        const available = gang.fighters.filter(f => !this.state.mySelected.includes(f.id));
        for (let i = 0; i < n && available.length > 0; i++) {
          const idx = Math.floor(Math.random() * available.length);
          this.state.mySelected.push(available[idx].id);
          available.splice(idx, 1);
        }
        this.render();
      },

      toggleOpponent(id) {
        if (this.state.oppGangIds.includes(id)) {
          this.state.oppGangIds = this.state.oppGangIds.filter(x => x !== id);
        } else {
          this.state.oppGangIds.push(id);
        }
        this.render();
      },

      toggleDeck(id) {
        if (this.state.deckIds.includes(id)) {
          this.state.deckIds = this.state.deckIds.filter(x => x !== id);
        } else {
          this.state.deckIds.push(id);
        }
        this.render();
      },

      toggleTactic(id) {
        if (this.state.tacticIds.includes(id)) {
          this.state.tacticIds = this.state.tacticIds.filter(x => x !== id);
        } else {
          this.state.tacticIds.push(id);
        }
        this.render();
      },

      addRandomTactics() {
        const pool = DATA.tactics.decks
          .filter(d => this.state.deckIds.includes(d.id))
          .flatMap(d => d.cards);
        const n = parseInt(prompt('How many random tactics?', '3')) || 3;
        const available = pool.filter(c => !this.state.tacticIds.includes(c.id));
        for (let i = 0; i < n && available.length > 0; i++) {
          const idx = Math.floor(Math.random() * available.length);
          this.state.tacticIds.push(available[idx].id);
          available.splice(idx, 1);
        }
        this.render();
      },

      toggleHirePool(id) {
        if (this.state.selectedHirePoolIds.includes(id)) {
          this.state.selectedHirePoolIds = this.state.selectedHirePoolIds.filter(x => x !== id);
        } else {
          this.state.selectedHirePoolIds.push(id);
        }
        this.render();
      },

      toggleHire(id) {
        if (this.state.selectedHireFighterIds.includes(id)) {
          this.state.selectedHireFighterIds = this.state.selectedHireFighterIds.filter(x => x !== id);
        } else {
          this.state.selectedHireFighterIds.push(id);
        }
        this.render();
      },

      addRandomHires() {
        const pools = DATA.hires.pools.filter(p => this.state.selectedHirePoolIds.includes(p.id));
        const allHires = pools.flatMap(p => p.fighters.map(f => `${p.id}_${f.id}`));
        const n = parseInt(prompt('How many random hires?', '2')) || 2;
        const available = allHires.filter(id => !this.state.selectedHireFighterIds.includes(id));
        for (let i = 0; i < n && available.length > 0; i++) {
          const idx = Math.floor(Math.random() * available.length);
          this.state.selectedHireFighterIds.push(available[idx]);
          available.splice(idx, 1);
        }
        this.render();
      },

      toggleCardExpanded(key) {
        this.state.expandedCards[key] = !this.state.expandedCards[key];
        this.render();
      },

      addXP(key, note, xp) {
        if (!this.state.tracking[key]) {
          this.state.tracking[key] = { xpLog: [], misc: 0, ooa: false, serious: 0, injuryNotes: [], meta: {} };
        }
        this.state.tracking[key].xpLog.push({ note, xp, ts: Date.now() });
        this.render();
      },

      setMiscXP(key, value) {
        if (!this.state.tracking[key]) return;
        this.state.tracking[key].misc = parseInt(value) || 0;
      },

      toggleOoA(key) {
        if (!this.state.tracking[key]) return;
        this.state.tracking[key].ooa = !this.state.tracking[key].ooa;
        this.render();
      },

      addInjury(key, injury) {
        if (!this.state.tracking[key]) return;
        this.state.tracking[key].serious++;
        this.state.tracking[key].injuryNotes.push(`Sustained Injury: ${injury}`);
        this.render();
      },

      clearLog(key) {
        if (!confirm('Clear all events for this fighter?')) return;
        if (!this.state.tracking[key]) return;
        this.state.tracking[key].xpLog = [];
        this.state.tracking[key].injuryNotes = [];
        this.state.tracking[key].misc = 0;
        this.render();
      },

      showOoAModal(key) {
        const enemies = this.state.oppGangIds.flatMap(gid => {
          const g = DATA.gangs.find(x => x.id === gid);
          return g ? g.fighters.map(f => ({ ...f, gangName: g.name })) : [];
        });

        if (enemies.length === 0) {
          alert('No opponent gangs selected!');
          return;
        }

        const body = `
          <p style="margin-bottom:12px;font-weight:700;">Select target taken Out of Action:</p>
          ${enemies.map(f => `
            <button onclick="app.recordOoA('${key}', '${f.name}', '${f.role}')" style="width:100%;margin:4px 0;">
              ${f.name} (${f.role}) - ${f.gangName}
            </button>
          `).join('')}
        `;

        this.openModal('Out of Action', encodeURIComponent(body));
      },

      recordOoA(key, name, role) {
        let xp = 2;
        if (role === 'Leader' || role === 'Champion') xp = 3;
        this.addXP(key, `Put ${name} (${role}) OoA`, xp);
        this.closeModal();
      },

      generateReport() {
        const gang = DATA.gangs.find(g => g.id === this.state.myGangId);
        const scenario = DATA.scenarios.find(s => s.id === this.state.scenarioId);
        
        let report = '=== NECROMUNDA BATTLE REPORT ===\n\n';
        
        if (scenario) {
          report += `SCENARIO: ${scenario.name}\n${scenario.text}\n\n`;
        }
        
        if (gang) {
          report += `MY GANG: ${gang.name}\n\n`;
          
          this.state.mySelected.forEach(fid => {
            const f = gang.fighters.find(x => x.id === fid);
            if (!f) return;
            const key = `gang_${fid}`;
            const t = this.state.tracking[key];
            if (!t) return;
            
            const totalXP = t.xpLog.reduce((sum, e) => sum + e.xp, 0) + t.misc;
            report += `${f.name} (${f.role}) - Rating: ${f.rating}\n`;
            report += `  Total XP: ${totalXP}\n`;
            if (t.ooa) report += `  STATUS: OUT OF ACTION\n`;
            report += `  Serious Injuries: ${t.serious}\n`;
            t.xpLog.forEach(e => report += `  - ${e.note} (+${e.xp})\n`);
            if (t.misc > 0) report += `  - Misc XP: +${t.misc}\n`;
            t.injuryNotes.forEach(n => report += `  - ${n}\n`);
            report += '\n';
          });
        }
        
        if (this.state.selectedHireFighterIds.length > 0) {
          report += 'HIRED GUNS:\n\n';
          this.state.selectedHireFighterIds.forEach(hid => {
            const [poolId, fid] = hid.split('_');
            const pool = DATA.hires.pools.find(p => p.id === poolId);
            const f = pool?.fighters.find(x => x.id === fid);
            if (!f) return;
            const key = `hire_${hid}`;
            const t = this.state.tracking[key];
            if (!t) return;
            
            const totalXP = t.xpLog.reduce((sum, e) => sum + e.xp, 0) + t.misc;
            report += `${f.name} (${f.role}) - ${pool.name} - Rating: ${f.rating}\n`;
            report += `  Total XP: ${totalXP}\n`;
            if (t.ooa) report += `  STATUS: OUT OF ACTION\n`;
            report += `  Serious Injuries: ${t.serious}\n`;
            t.xpLog.forEach(e => report += `  - ${e.note} (+${e.xp})\n`);
            if (t.misc > 0) report += `  - Misc XP: +${t.misc}\n`;
            t.injuryNotes.forEach(n => report += `  - ${n}\n`);
            report += '\n';
          });
        }
        
        if (this.state.tacticIds.length > 0) {
          report += 'TACTICS USED:\n';
          this.state.tacticIds.forEach(tid => {
            const c = DATA.tactics.decks.flatMap(d => d.cards.map(x => ({...x, deckName: d.name}))).find(x => x.id === tid);
            if (c) report += `- ${c.name} (${c.deckName})\n`;
          });
          report += '\n';
        }
        
        if (this.state.oppGangIds.length > 0) {
          report += 'OPPONENTS:\n';
          this.state.oppGangIds.forEach(gid => {
            const g = DATA.gangs.find(x => x.id === gid);
            if (g) report += `- ${g.name}\n`;
          });
        }
        
        return report;
      },

      render() {
        this.renderSetup();
        this.renderBattle();
        this.renderReport();
        this.renderCheatSheet();
      },

      renderSetup() {
        const gang = DATA.gangs.find(g => g.id === this.state.myGangId);
        const scenario = DATA.scenarios.find(s => s.id === this.state.scenarioId);
        
        const html = `
          <!-- SCENARIO -->
          <div class="section">
            <h2>SCENARIO</h2>
            <label>Select Scenario:</label>
            <select onchange="app.state.scenarioId = this.value || null; app.render();">
              <option value="">-- Select Scenario --</option>
              ${DATA.scenarios.map(s => `<option value="${s.id}" ${s.id === this.state.scenarioId ? 'selected' : ''}>${s.name}</option>`).join('')}
            </select>
            <button onclick="app.state.scenarioId = DATA.scenarios[Math.floor(Math.random()*DATA.scenarios.length)].id; app.render();" style="margin-top:8px;margin-right:8px;">🎲 RANDOM</button>
            <button class="secondary" onclick="app.openModal('${scenario?.name || ''}', '<p>${encodeURIComponent(scenario?.text) || ''}</p>')" style="margin-top:8px;">📖 DETAILS</button>
          </div>

          <!-- MY GANG -->
          <div class="section">
            <h2>MY GANG</h2>
            <label>Select Gang:</label>
            <select onchange="app.state.myGangId = this.value || null; app.state.mySelected = []; app.render();">
              <option value="">-- Select Gang --</option>
              ${DATA.gangs.map(g => `<option value="${g.id}" ${g.id === this.state.myGangId ? 'selected' : ''}>${g.name}</option>`).join('')}
            </select>
            
            ${gang ? `
              <div style="display:flex;gap:8px;flex-wrap:wrap;margin:12px 0;">
                <span class="chip">Selected: ${this.state.mySelected.length}</span>
                <span class="chip">Rating: ${this.state.mySelected.reduce((sum,id) => sum+(gang.fighters.find(f=>f.id===id)?.rating||0),0)}</span>
              </div>
              
              <table>
                <thead>
                  <tr><th style="width:15%">Select</th><th style="width:40%">Name</th><th style="width:25%">Role</th><th style="width:20%">Rating</th></tr>
                </thead>
                <tbody>
                  ${gang.fighters.map(f => `
                    <tr>
                      <td><input type="checkbox" ${this.state.mySelected.includes(f.id) ? 'checked' : ''} onchange="app.toggleFighter('${f.id}')"></td>
                      <td>${f.name}</td>
                      <td>${f.role}</td>
                      <td>${f.rating}</td>
                    </tr>
                  `).join('')}
                </tbody>
              </table>
              
              <button class="success" onclick="app.addRandomFighters()" style="margin-right:8px;">🎲 ADD RANDOM</button>
              <button class="danger" onclick="app.state.mySelected = []; app.render();">❌ CLEAR</button>
            ` : ''}
          </div>

          <!-- OPPONENTS -->
          <div class="section">
            <h2>OPPONENT GANGS</h2>
            ${DATA.gangs.map(g => `
              <label class="checkbox-label">
                <input type="checkbox" ${this.state.oppGangIds.includes(g.id) ? 'checked' : ''} onchange="app.toggleOpponent('${g.id}')">
                <strong>${g.name}</strong>
              </label>
            `).join('')}
          </div>

          <!-- TACTICS -->
          <div class="section">
            <h2>TACTICS</h2>
            <label>Select Decks:</label>
            ${DATA.tactics.decks.map(d => `
              <label class="checkbox-label">
                <input type="checkbox" ${this.state.deckIds.includes(d.id) ? 'checked' : ''} onchange="app.toggleDeck('${d.id}')">
                <strong>${d.name}</strong>
              </label>
            `).join('')}
            
            ${this.state.deckIds.length > 0 ? `
              <table>
                <thead>
                  <tr><th style="width:15%">Select</th><th style="width:40%">Card</th><th style="width:30%">Deck</th><th style="width:15%">View</th></tr>
                </thead>
                <tbody>
                  ${DATA.tactics.decks
                    .filter(d => this.state.deckIds.includes(d.id))
                    .flatMap(d => d.cards.map(c => ({...c, deckName: d.name})))
                    .map(c => `
                      <tr>
                        <td><input type="checkbox" ${this.state.tacticIds.includes(c.id) ? 'checked' : ''} onchange="app.toggleTactic('${c.id}')"></td>
                        <td>${c.name}</td>
                        <td>${c.deckName}</td>
                        <td><button onclick="app.openModal('${c.name}', '<p>${encodeURIComponent(c.text)}</p>')" style="padding:4px 8px;font-size:12px;">VIEW</button></td>
                      </tr>
                    `).join('')}
                </tbody>
              </table>
              
              <button class="toxic" onclick="app.addRandomTactics()" style="margin-right:8px;">🎲 ADD RANDOM</button>
              <button class="danger" onclick="app.state.tacticIds = []; app.render();">❌ CLEAR</button>
            ` : ''}
          </div>

          <!-- HIRES -->
          <div class="section">
            <h2>BOUNTY HUNTERS & HIRED GUNS</h2>
            <label>Enable Pools:</label>
            ${DATA.hires.pools.map(p => `
              <label class="checkbox-label">
                <input type="checkbox" ${this.state.selectedHirePoolIds.includes(p.id) ? 'checked' : ''} onchange="app.toggleHirePool('${p.id}')">
                <strong>${p.name}</strong>
              </label>
            `).join('')}
            
            ${this.state.selectedHirePoolIds.length > 0 ? (() => {
              const pools = DATA.hires.pools.filter(p => this.state.selectedHirePoolIds.includes(p.id));
              const allHires = pools.flatMap(p => p.fighters.map(f => ({...f, poolId: p.id, poolName: p.name, fid: `${p.id}_${f.id}`})));
              
              return `
                <div style="display:flex;gap:8px;flex-wrap:wrap;margin:12px 0;">
                  <span class="chip">Hires: ${this.state.selectedHireFighterIds.length}</span>
                  <span class="chip">Rating: ${this.state.selectedHireFighterIds.reduce((sum,id) => sum+(allHires.find(f=>f.fid===id)?.rating||0),0)}</span>
                </div>
                
                <table>
                  <thead>
                    <tr><th style="width:12%">Select</th><th style="width:30%">Name</th><th style="width:20%">Role</th><th style="width:18%">Rating</th><th style="width:20%">Pool</th></tr>
                  </thead>
                  <tbody>
                    ${allHires.map(f => `
                      <tr>
                        <td><input type="checkbox" ${this.state.selectedHireFighterIds.includes(f.fid) ? 'checked' : ''} onchange="app.toggleHire('${f.fid}')"></td>
                        <td>${f.name}</td>
                        <td>${f.role}</td>
                        <td>${f.rating}</td>
                        <td>${f.poolName}</td>
                      </tr>
                    `).join('')}
                  </tbody>
                </table>
                
                <button class="success" onclick="app.addRandomHires()" style="margin-right:8px;">🎲 ADD RANDOM</button>
                <button class="danger" onclick="app.state.selectedHireFighterIds = []; app.render();">❌ CLEAR</button>
              `;
            })() : ''}
          </div>
        `;
        
        document.getElementById('setup-page').innerHTML = html;
      },

      renderBattle() {
        const gang = DATA.gangs.find(g => g.id === this.state.myGangId);
        
        let html = `
          <!-- TACTICS IN PLAY -->
          <div class="tactics-panel">
            <h3>TACTICS IN PLAY</h3>
            <div>
              ${this.state.tacticIds.length > 0 ? this.state.tacticIds.map(tid => {
                const c = DATA.tactics.decks.flatMap(d => d.cards).find(x => x.id === tid);
                return c ? `<span class="chip" style="cursor:pointer;" onclick="app.openModal('${c.name}', '<p>${encodeURIComponent(c.text)}</p>')">${c.name}</span>` : '';
              }).join('') : '<span class="chip">None selected</span>'}
            </div>
          </div>
        `;
        
        if (gang) {
          const gangFighters = this.state.mySelected.map(fid => {
            const f = gang.fighters.find(x => x.id === fid);
            if (!f) return null;
            const key = `gang_${fid}`;
            if (!this.state.tracking[key]) {
              this.state.tracking[key] = { xpLog: [], misc: 0, ooa: false, serious: 0, injuryNotes: [], meta: { type: 'gang' } };
            }
            return { ...f, key, source: gang.name };
          }).filter(Boolean);

          const hireFighters = this.state.selectedHireFighterIds.map(hid => {
            const [poolId, fid] = hid.split('_');
            const pool = DATA.hires.pools.find(p => p.id === poolId);
            const f = pool?.fighters.find(x => x.id === fid);
            if (!f) return null;
            const key = `hire_${hid}`;
            if (!this.state.tracking[key]) {
              this.state.tracking[key] = { xpLog: [], misc: 0, ooa: false, serious: 0, injuryNotes: [], meta: { type: 'hire', poolId } };
            }
            return { ...f, key, source: `Hire: ${pool.name}` };
          }).filter(Boolean);

          const allFighters = [...gangFighters, ...hireFighters];

          allFighters.forEach(f => {
            const t = this.state.tracking[f.key] || { xpLog: [], misc: 0, ooa: false, serious: 0, injuryNotes: [], meta: {} };
            const totalXP = t.xpLog.reduce((sum, e) => sum + e.xp, 0) + t.misc;
            const isExpanded = this.state.expandedCards[f.key];

            html += `
              <div class="fighter-card ${t.ooa ? 'ooa' : ''} ${!isExpanded ? 'collapsed' : ''}" onclick="if(event.target.tagName !== 'BUTTON' && event.target.tagName !== 'INPUT' && event.target.tagName !== 'SELECT') app.toggleCardExpanded('${f.key}')">
                ${!isExpanded ? `
                  <div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:8px;">
                    <div>
                      <h3 style="font-size:18px;font-weight:900;text-transform:uppercase;margin-bottom:4px;">${f.name}</h3>
                      <div style="display:flex;gap:4px;flex-wrap:wrap;">
                        <span class="chip" style="font-size:10px;padding:4px 8px;">${f.role}</span>
                        <span class="chip" style="font-size:10px;padding:4px 8px;">XP: ${totalXP}</span>
                        ${t.ooa ? '<span class="chip" style="background:#ff3838;font-size:10px;padding:4px 8px;">OOA</span>' : ''}
                      </div>
                    </div>
                    <div style="font-size:24px;font-weight:900;color:${t.ooa?'#fafaf5':'#0a0a0a'};">▼</div>
                  </div>
                ` : `
                  <div style="display:flex;justify-content:space-between;align-items:flex-start;">
                    <h3 style="font-size:18px;font-weight:900;margin-bottom:12px;text-transform:uppercase;border-bottom:3px solid #0a0a0a;padding-bottom:8px;flex:1;">${f.name}</h3>
                    <div style="font-size:24px;font-weight:900;margin-left:12px;color:${t.ooa?'#fafaf5':'#0a0a0a'};">▲</div>
                  </div>
                  
                  <div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:12px;">
                    <span class="chip">${f.role}</span>
                    <span class="chip">${f.source}</span>
                    <span class="chip">Rating: ${f.rating}</span>
                    <span class="chip">XP: ${totalXP}</span>
                    <span class="chip">Serious: ${t.serious}</span>
                    ${t.ooa ? '<span class="chip" style="background:#ff3838;">OUT OF ACTION</span>' : ''}
                  </div>
                  
                  <div class="button-grid" onclick="event.stopPropagation();">
                    <button class="success" onclick="app.addXP('${f.key}','Serious Injury Caused',1)">+1 SERIOUS INJ</button>
                    <button class="success" onclick="app.addXP('${f.key}','Vehicle Wrecked',2)">+2 VEHICLE</button>
                    <button class="danger" onclick="app.showOoAModal('${f.key}')">+2 OUT OF ACTION</button>
                    <button class="secondary" onclick="app.addXP('${f.key}','Took Part',1)">+1 TOOK PART</button>
                    <button class="secondary" onclick="app.addXP('${f.key}','Rally',1)">+1 RALLY</button>
                    <button class="secondary" onclick="app.addXP('${f.key}','Assist Recovery',1)">+1 ASSIST</button>
                  </div>
                  
                  <div onclick="event.stopPropagation();">
                    <label style="display:block;font-weight:700;margin-top:12px;text-transform:uppercase;">Misc XP:</label>
                    <input type="number" value="${t.misc}" onchange="app.setMiscXP('${f.key}', this.value); app.render();" style="width:100%;padding:10px;border:4px solid #0a0a0a;background:#fafaf5;font-family:inherit;font-size:14px;margin-bottom:8px;box-shadow:3px 3px 0 #0a0a0a;">
                    
                    <div style="margin:12px 0;">
                      <label style="display:block;font-weight:700;text-transform:uppercase;">Add Serious Injury:</label>
                      <select id="injury_${f.key}" style="width:100%;padding:10px;border:4px solid #0a0a0a;background:#fafaf5;font-family:inherit;font-size:14px;margin-bottom:8px;box-shadow:3px 3px 0 #0a0a0a;">
                        ${DATA.injuries.map(inj => `<option value="${inj}">${inj}</option>`).join('')}
                      </select>
                      <button class="danger" onclick="app.addInjury('${f.key}', document.getElementById('injury_${f.key}').value)" style="margin-top:8px;">ADD INJURY</button>
                    </div>
                    
                    <button class="${t.ooa ? 'success' : 'danger'}" onclick="app.toggleOoA('${f.key}')" style="margin-right:8px;margin-top:8px;">
                      ${t.ooa ? '✓ REVIVE' : '💀 MARK OOA'}
                    </button>
                    <button class="danger" onclick="app.clearLog('${f.key}')" style="margin-top:8px;">CLEAR LOG</button>
                    
                    <div class="log">
                      ${t.xpLog.map(e => `<div class="log-entry">${e.note} (+${e.xp} XP)</div>`).join('')}
                      ${t.injuryNotes.map(n => `<div class="log-entry" style="color:${t.ooa?'#fafaf5':'#ff3838'};">🩸 ${n}</div>`).join('')}
                      ${t.xpLog.length === 0 && t.injuryNotes.length === 0 ? '<div class="log-entry">No events yet</div>' : ''}
                    </div>
                  </div>
                `}
              </div>
            `;
          });
        }
        
        html += `
          <div class="section">
            <h2>D66 LASTING INJURY TABLE</h2>
            <table style="font-size:12px;">
              <thead>
                <tr><th>D66</th><th>Result</th></tr>
              </thead>
              <tbody>
                <tr><td style="font-weight:900;background:#d94f2e;color:#fafaf5;">11-26</td><td>Out Cold: Miss next game</td></tr>
                <tr><td style="font-weight:900;background:#d94f2e;color:#fafaf5;">31-35</td><td>Convalescence: Miss D3 games</td></tr>
                <tr><td style="font-weight:900;background:#d94f2e;color:#fafaf5;">36</td><td>Humiliated: -1 XP</td></tr>
                <tr><td style="font-weight:900;background:#d94f2e;color:#fafaf5;">41-45</td><td>Head Injury: -1 Intelligence</td></tr>
                <tr><td style="font-weight:900;background:#d94f2e;color:#fafaf5;">46</td><td>Eye Injury: -1 BS</td></tr>
                <tr><td style="font-weight:900;background:#d94f2e;color:#fafaf5;">51</td><td>Hand Injury: -1 WS</td></tr>
                <tr><td style="font-weight:900;background:#d94f2e;color:#fafaf5;">52-53</td><td>Hobbled: -1 Movement</td></tr>
                <tr><td style="font-weight:900;background:#d94f2e;color:#fafaf5;">54</td><td>Spinal Injury: -1 Strength</td></tr>
                <tr><td style="font-weight:900;background:#d94f2e;color:#fafaf5;">55</td><td>Enfeebled: -1 Toughness</td></tr>
                <tr><td style="font-weight:900;background:#d94f2e;color:#fafaf5;">56</td><td>Partially Deafened: -1 Cool/Willpower</td></tr>
                <tr><td style="font-weight:900;background:#d94f2e;color:#fafaf5;">61-65</td><td>Multiple Injuries: Roll twice</td></tr>
                <tr><td style="font-weight:900;background:#d94f2e;color:#fafaf5;">66</td><td>Memorable Death: Remove from roster</td></tr>
              </tbody>
            </table>
          </div>
        `;
        
        document.getElementById('battle-page').innerHTML = html;
      },

      renderReport() {
        const report = this.generateReport();
        
        const html = `
          <div class="section">
            <h2>📋 BATTLE REPORT</h2>
            <button class="success" style="margin-right:8px;">📝 GENERATE</button>
            <button onclick="navigator.clipboard.writeText(document.getElementById('reportText').value).then(() => alert('Report copied!'));">📋 COPY</button>
            <textarea id="reportText" rows="30" style="width:100%;padding:10px;border:4px solid #0a0a0a;background:#fafaf5;font-family:monospace;font-size:14px;margin-top:12px;box-shadow:3px 3px 0 #0a0a0a;" readonly>${report}</textarea>
          </div>
        `;
        
        document.getElementById('report-page').innerHTML = html;
      },

      renderCheatSheet() {
        const html = `
          <div class="section">
            <h2>📖 PHASE SEQUENCE</h2>
            <ol style="line-height:2;">
              <li><strong>Priority:</strong> Roll off (highest wins)</li>
              <li><strong>Activation:</strong> Alternate activating fighters</li>
              <li><strong>End Phase:</strong> Rally, remove blast markers, reset status</li>
              <li><strong>Recovery:</strong> Roll for Seriously Injured fighters</li>
            </ol>
          </div>

          <div class="section">
            <h2>ACTIONS</h2>
            <table>
              <thead>
                <tr><th>Action</th><th>Effect</th></tr>
              </thead>
              <tbody>
                <tr><td>Move (Simple)</td><td>Move up to M"</td></tr>
                <tr><td>Charge (Double)</td><td>Move + engage enemy</td></tr>
                <tr><td>Shoot (Basic/Double)</td><td>Make ranged attack</td></tr>
                <tr><td>Fight (Basic)</td><td>Make close combat attacks</td></tr>
                <tr><td>Take Cover (Basic)</td><td>+1 to save until activation</td></tr>
                <tr><td>Coup de Grace (Simple)</td><td>Auto-wound Seriously Injured</td></tr>
              </tbody>
            </table>
          </div>

          <div class="section">
            <h2>HIT MODIFIERS</h2>
            <table>
              <thead>
                <tr><th>Situation</th><th>Modifier</th></tr>
              </thead>
              <tbody>
                <tr><td>Target in Cover</td><td>-1</td></tr>
                <tr><td>Target Obscured</td><td>-1</td></tr>
                <tr><td>Long Range</td><td>-1</td></tr>
                <tr><td>Firing from High Ground</td><td>+1</td></tr>
                <tr><td>Aiming (Shoot Double)</td><td>+1</td></tr>
              </tbody>
            </table>
          </div>

          <div class="section">
            <h2>INJURY ROLL</h2>
            <table>
              <thead>
                <tr><th>Roll</th><th>Result</th></tr>
              </thead>
              <tbody>
                <tr><td>1-2</td><td>Flesh Wound</td></tr>
                <tr><td>3-5</td><td>Seriously Injured</td></tr>
                <tr><td>6+</td><td>Out of Action</td></tr>
              </tbody>
            </table>
          </div>

          <div class="section">
            <h2>🏆 EXPERIENCE</h2>
            <table>
              <thead>
                <tr><th>Achievement</th><th>XP</th></tr>
              </thead>
              <tbody>
                <tr><td>Took Part in Battle</td><td>+1</td></tr>
                <tr><td>Put Enemy Out of Action</td><td>+2</td></tr>
                <tr><td>Put Enemy Leader/Champion OoA</td><td>+3</td></tr>
                <tr><td>Caused Serious Injury</td><td>+1</td></tr>
                <tr><td>Rallied</td><td>+1</td></tr>
                <tr><td>Assisted Recovery</td><td>+1</td></tr>
                <tr><td>Wrecked Vehicle</td><td>+2</td></tr>
              </tbody>
            </table>
          </div>
        `;
        
        document.getElementById('cheat-page').innerHTML = html;
      }
    };

    // Initialize on load
    document.addEventListener('DOMContentLoaded', () => app.init());
  </script>
</body>
</html>